name: Testing large SQL
source: success-eng---postgres
type: raw_sql
rawSql: |-
    SELECT
        "ND Testing Replace Trait",
        "birthday",
        "gender",
        "country",
        "context_library_name",
        "last_name",
        "email",
        "dob",
        "first_name",
        "id",
        "context_integrations_lifetime_value",
        "uuid_ts",
        "lifetime_value",
        "full_name",
        "context_library_version",
        "ip_address",
        "last_purchase_date",
        "ltv_parent",
        "received_at",
      CASE
          WHEN (
            (((_ht_split_index % 2) + 1) >= 1) AND
            (((_ht_split_index % 2) + 1) <= 1)
          ) THEN 'Group A'
          WHEN (
            (((_ht_split_index % 2) + 1) >= 2) AND
            (((_ht_split_index % 2) + 1) <= 2)
          ) THEN 'Group B'
      END AS "split_name"
    FROM (
      
        SELECT
          *,
           abs(
        (
          'x' || substr(md5(concat(cast("id" as text),cast('default' as text))), 1, 8)
        )::bit(32)::int
      ) AS _ht_split_index
        FROM (
          
SELECT
  "count_9c63865045bc528361bf1c13d2fd74bf" AS "ND Testing Replace Trait"
,  "birthday_e480af" AS "birthday"
,  "gender_5f05e4" AS "gender"
,  "country_febbeb" AS "country"
,  "context_library_name_0eb7b9" AS "context_library_name"
,  "last_name_cce236" AS "last_name"
,  "email_1d058e" AS "email"
,  "dob_a7e948" AS "dob"
,  "first_name_832234" AS "first_name"
,  "id_56378b" AS "id"
,  "context_integrations_lifetime_value_323403" AS "context_integrations_lifetime_value"
,  "uuid_ts_21d597" AS "uuid_ts"
,  "lifetime_value_69c64c" AS "lifetime_value"
,  "full_name_9354e9" AS "full_name"
,  "context_library_version_850962" AS "context_library_version"
,  "ip_address_e5195b" AS "ip_address"
,  "last_purchase_date_eb686f" AS "last_purchase_date"
,  "ltv_parent_df4994" AS "ltv_parent"
,  "received_at_98239c" AS "received_at"
FROM (
  
SELECT *
FROM (
  
SELECT
    "gender_5f05e4"
  AS "gender_5f05e4"
,    "birthday_e480af"
  AS "birthday_e480af"
,    "id_56378b"
  AS "id_56378b"
,    "country_febbeb"
  AS "country_febbeb"
,    "context_library_name_0eb7b9"
  AS "context_library_name_0eb7b9"
,    "last_name_cce236"
  AS "last_name_cce236"
,    "email_1d058e"
  AS "email_1d058e"
,    "dob_a7e948"
  AS "dob_a7e948"
,    "first_name_832234"
  AS "first_name_832234"
,    "context_integrations_lifetime_value_323403"
  AS "context_integrations_lifetime_value_323403"
,    "uuid_ts_21d597"
  AS "uuid_ts_21d597"
,    "lifetime_value_69c64c"
  AS "lifetime_value_69c64c"
,    "full_name_9354e9"
  AS "full_name_9354e9"
,    "context_library_version_850962"
  AS "context_library_version_850962"
,    "ip_address_e5195b"
  AS "ip_address_e5195b"
,    "last_purchase_date_eb686f"
  AS "last_purchase_date_eb686f"
,    "ltv_parent_df4994"
  AS "ltv_parent_df4994"
,    "received_at_98239c"
  AS "received_at_98239c"
,    COALESCE("count_243937e3d8fe8aa6eb20a746fb026f75", 0)
  AS "count_243937e3d8fe8aa6eb20a746fb026f75"
,    "user_id_1eeb7e"
  AS "user_id_1eeb7e"
,    COALESCE("count_9c63865045bc528361bf1c13d2fd74bf", 0)
  AS "count_9c63865045bc528361bf1c13d2fd74bf"
,    "user_id_630d61"
  AS "user_id_630d61"
FROM (
  
SELECT
  "gender" AS "gender_5f05e4"
,  "birthday" AS "birthday_e480af"
,  "id" AS "id_56378b"
,  "country" AS "country_febbeb"
,  "context_library_name" AS "context_library_name_0eb7b9"
,  "last_name" AS "last_name_cce236"
,  "email" AS "email_1d058e"
,  "dob" AS "dob_a7e948"
,  "first_name" AS "first_name_832234"
,  "context_integrations_lifetime_value" AS "context_integrations_lifetime_value_323403"
,  "uuid_ts" AS "uuid_ts_21d597"
,  "lifetime_value" AS "lifetime_value_69c64c"
,  "full_name" AS "full_name_9354e9"
,  "context_library_version" AS "context_library_version_850962"
,  "ip_address" AS "ip_address_e5195b"
,  "last_purchase_date" AS "last_purchase_date_eb686f"
,  "ltv_parent" AS "ltv_parent_df4994"
,  "received_at" AS "received_at_98239c"
FROM (
  SELECT
  "birthday" AS "birthday"
,  "gender" AS "gender"
,  "country" AS "country"
,  "context_library_name" AS "context_library_name"
,  "last_name" AS "last_name"
,  "email" AS "email"
,  "dob" AS "dob"
,  "first_name" AS "first_name"
,  "id" AS "id"
,  "context_integrations_lifetime_value" AS "context_integrations_lifetime_value"
,  "uuid_ts" AS "uuid_ts"
,  "lifetime_value"::FLOAT AS "lifetime_value"
,  "full_name" AS "full_name"
,  "context_library_version" AS "context_library_version"
,  "ip_address" AS "ip_address"
,  "last_purchase_date" AS "last_purchase_date"
,  "ltv_parent" AS "ltv_parent"
,  "received_at" AS "received_at"
FROM
(
  -- Model 250728 (All Users_Updated)
SELECT CAST(dob AS timestamp) As birthday,cast(lifetime_value as int) as ltv_parent, * FROM warby_parker_demo.users
) _ht_with_column_casts
) ignored_3d1ed758fba53014d4d566ae67db9253
) ignored_473865c1fe8beb6fe2e44129f864a762
  LEFT JOIN (
    
SELECT
    "user_id_1eeb7e",
    COUNT( "one_727083") AS "count_243937e3d8fe8aa6eb20a746fb026f75"
FROM (
  
SELECT *
FROM (
  
SELECT
    "one_727083"
  AS "one_727083"
,    "abandoned_date_3ce6b1"
  AS "abandoned_date_3ce6b1"
,    "user_id_1eeb7e"
  AS "user_id_1eeb7e"
,    COALESCE("count_8dd34cb83e494795c3e96d9f646385c6", 0)
  AS "count_8dd34cb83e494795c3e96d9f646385c6"
,    "abandoned_date_e33b2a"
  AS "abandoned_date_e33b2a"
,    "user_id_6b006c"
  AS "user_id_6b006c"
FROM (
  
SELECT
  1 AS "one_727083"
,  "abandoned_date" AS "abandoned_date_3ce6b1"
,  "user_id" AS "user_id_1eeb7e"
FROM (
  -- Model 250704 (Abandoned Cart)
SELECT CAST(original_timestamp AS timestamp) As Abandoned_Date, * FROM warby_parker_demo.cart_abandoned UNION ALL
select '2023-09-08T17:16:36.729Z', '12', '2023-09-08T00:00:00.000Z', 'ignore', 'True','ignore', 'ignore', '12', 'ignore', 
  'ignore', 'ignore', 'ignore', 'ignore', 'ignore', '2023-09-08T00:00:00.000Z', '2023-09-08T00:00:00.000Z', '12', 'ignore', 'False', 
  'ignore', '2023-09-08T00:00:00.000Z', 'ignore', 'ignore', 'ignore', 'ignore' 
order by Abandoned_Date desc
) ignored_9f8361e384d09b325662a23d90d4575d
) ignored_5b54a61093bf48de9a71dc57f269da66
  LEFT JOIN (
    
SELECT
    "abandoned_date_e33b2a",
    "user_id_6b006c",
    COUNT(1) AS "count_8dd34cb83e494795c3e96d9f646385c6"
FROM (
  
SELECT *
FROM (
  
SELECT
    "user_id_6b006c"
  AS "user_id_6b006c"
,    "abandoned_date_e33b2a"
  AS "abandoned_date_e33b2a"
,    "id_7be7b0"
  AS "id_7be7b0"
,    "checkout_date_8ff532"
  AS "checkout_date_8ff532"
,    "user_id_85f262"
  AS "user_id_85f262"
FROM (
  
SELECT
  "user_id" AS "user_id_6b006c"
,  "abandoned_date" AS "abandoned_date_e33b2a"
FROM (
  -- Model 250704 (Abandoned Cart)
SELECT CAST(original_timestamp AS timestamp) As Abandoned_Date, * FROM warby_parker_demo.cart_abandoned UNION ALL
select '2023-09-08T17:16:36.729Z', '12', '2023-09-08T00:00:00.000Z', 'ignore', 'True','ignore', 'ignore', '12', 'ignore', 
  'ignore', 'ignore', 'ignore', 'ignore', 'ignore', '2023-09-08T00:00:00.000Z', '2023-09-08T00:00:00.000Z', '12', 'ignore', 'False', 
  'ignore', '2023-09-08T00:00:00.000Z', 'ignore', 'ignore', 'ignore', 'ignore' 
order by Abandoned_Date desc
) ignored_4925387d1b1a476ff4007470b8bbded8
) ignored_343dfe8eacc87272d1e6f249b254c463
  LEFT JOIN (
    
SELECT
  "id" AS "id_7be7b0"
FROM (
  SELECT
  "birthday" AS "birthday"
,  "gender" AS "gender"
,  "country" AS "country"
,  "context_library_name" AS "context_library_name"
,  "last_name" AS "last_name"
,  "email" AS "email"
,  "dob" AS "dob"
,  "first_name" AS "first_name"
,  "id" AS "id"
,  "context_integrations_lifetime_value" AS "context_integrations_lifetime_value"
,  "uuid_ts" AS "uuid_ts"
,  "lifetime_value"::FLOAT AS "lifetime_value"
,  "full_name" AS "full_name"
,  "context_library_version" AS "context_library_version"
,  "ip_address" AS "ip_address"
,  "last_purchase_date" AS "last_purchase_date"
,  "ltv_parent" AS "ltv_parent"
,  "received_at" AS "received_at"
FROM
(
  -- Model 250728 (All Users_Updated)
SELECT CAST(dob AS timestamp) As birthday,cast(lifetime_value as int) as ltv_parent, * FROM warby_parker_demo.users
) _ht_with_column_casts
) ignored_e7f6172968d770e759f6067636d65eb6
  ) ignored_fe32c6387560a1a2a684fe08f981acce
  ON "user_id_6b006c" = "id_7be7b0"
  LEFT JOIN (
    
SELECT
  "checkout_date" AS "checkout_date_8ff532"
,  "user_id" AS "user_id_85f262"
FROM (
  -- Funnel condition
-- Model 250703 (Completed Order)
SELECT
  CAST(original_timestamp AS TIMESTAMP) AS Checkout_Date,
  (NOW() - INTERVAL '2 day') AS old_checkout_date, 
  cast(price as int) as price_num,
  frame_name as sku,
  *
FROM
  warby_parker_demo.order_completed
) ignored_25c140ebf9ee7a46b70d45547beb1375
  ) ignored_40a93282bdf78ff7a69b507ab1c4ce7c
  ON "id_7be7b0" = "user_id_85f262"

) ignored_1ff327a016846310c18d30a73cc8e927
WHERE ("checkout_date_8ff532" > "abandoned_date_e33b2a")

) ignored_f86e64481d4315373aeba2ee2b4be942
GROUP BY
    "abandoned_date_e33b2a"
,    "user_id_6b006c"

  ) ignored_57aa99cf05a47e4178f2e955d323e587
  ON "abandoned_date_3ce6b1" = "abandoned_date_e33b2a" AND "user_id_1eeb7e" = "user_id_6b006c"

) ignored_ce96b7412742ad3d4347dbac386310e8
WHERE ("count_8dd34cb83e494795c3e96d9f646385c6" = 0)

) ignored_d5e6b2d43fc2fd8c7bd3901059dad4ea
GROUP BY
    "user_id_1eeb7e"

  ) ignored_1a0caa418848ec44df90dfdf4114ebad
  ON "id_56378b" = "user_id_1eeb7e"
  LEFT JOIN (
    
SELECT
    "user_id_630d61",
    COUNT(DISTINCT "color_3ce605") AS "count_9c63865045bc528361bf1c13d2fd74bf"
FROM (
  
SELECT *
FROM (
  
SELECT
    "abandoned_date_1447d9"
  AS "abandoned_date_1447d9"
,    "user_id_630d61"
  AS "user_id_630d61"
,    "color_3ce605"
  AS "color_3ce605"
FROM (
  
SELECT
  "abandoned_date" AS "abandoned_date_1447d9"
,  "user_id" AS "user_id_630d61"
,  "color" AS "color_3ce605"
FROM (
  -- Model 250704 (Abandoned Cart)
SELECT CAST(original_timestamp AS timestamp) As Abandoned_Date, * FROM warby_parker_demo.cart_abandoned UNION ALL
select '2023-09-08T17:16:36.729Z', '12', '2023-09-08T00:00:00.000Z', 'ignore', 'True','ignore', 'ignore', '12', 'ignore', 
  'ignore', 'ignore', 'ignore', 'ignore', 'ignore', '2023-09-08T00:00:00.000Z', '2023-09-08T00:00:00.000Z', '12', 'ignore', 'False', 
  'ignore', '2023-09-08T00:00:00.000Z', 'ignore', 'ignore', 'ignore', 'ignore' 
order by Abandoned_Date desc
) ignored_f9f62587e69b0e17d32bafb9102b901b
) ignored_3ea99b7d79b90e1b58269cdeab0e19bd

) ignored_e9c05c7a176a7367809a2b5471435099
WHERE (("abandoned_date_1447d9" IS NOT NULL))

) ignored_ed9d03413208ff0bde9ea0e746d86cb8
GROUP BY
    "user_id_630d61"

  ) ignored_0dcfcaad48fee58eacf8e3ab198de8c3
  ON "id_56378b" = "user_id_630d61"

) ignored_882ed5093bffd4b265bf0b179ebc7c72
WHERE ((LOWER("gender_5f05e4") LIKE LOWER('Female'))) AND (("birthday_e480af" > TIMESTAMP WITH TIME ZONE '1991-10-01 00:01:56')) AND (("count_243937e3d8fe8aa6eb20a746fb026f75" >= 2))

) ignored_599aa78099562c9f9673b202277e984d
        ) _ht_audience
    
    ) AS _ht_with_split_index
primaryKey: id
